"use strict";define(["angular","pnotify"],function(e){var a=require("pnotify");a.prototype.options.styling="bootstrap3";var t="userManageCtrl";return{route:{path:"userManage",route:{url:"/userManage",templateUrl:"tpls/userManage.html",controller:t}},ctrl:{name:t,fn:["$scope","$http","$state",function(e,t,r){function n(e,a,t){if(null==e)return"未知时间";var r=new Date(e),n=r.toLocaleString();return n}function i(a,t,r){var n="",i="",o="";return e.editUser&&(n='<a data-op="edit" data-userName="'+t.userName+'"  class="opBtn" title="编辑用户"><span class="glyphicon glyphicon-edit"></span></a>'),e.deleteUser&&(i='<a data-op="delete" data-userName="'+t.userName+'" class="opBtn" title="删除用户"><span class="glyphicon glyphicon-trash"></span></a>'),o='<a data-op="editUserRole" data-userName="'+t.userName+'" class="opBtn" title="分配角色"><span class="glyphicon glyphicon-plus"></span></a>',n+i+o}e.premission=null,e.canAddUser=!0,e.editUser=e.deleteNavBtn=e.editUserRole=!1,e.ajaxRequest=function(a){var r=t({url:config.api+"/user",method:"GET",withCredentials:!0,params:a.data});null===e.premission?t({url:config.api+"/getPermission",method:"GET",withCredentials:!0,params:{functionModel:101}}).then(function(a){e.premission=a.data;var t=!0,n=!1,i=void 0;try{for(var o,s=e.premission[Symbol.iterator]();!(t=(o=s.next()).done);t=!0){var d=o.value;"addUser"===d.permissionName&&(e.canAddUser=!1),"editUser"===d.permissionName&&(e.editUser=!0),"deleteUser"===d.permissionName&&(e.deleteUser=!0),"editUserRole"===d.permissionName&&(e.editUserRole=!0)}}catch(l){n=!0,i=l}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw i}}return r}).then(function(e){a.success(e.data)}):r.then(function(e){a.success(e.data)})},e.tableCtrl={options:{toolbar:"#toolbar",ajax:e.ajaxRequest,rowStyle:function(e,a){return{classes:"none"}},sidePagination:"server",cache:!1,height:500,striped:!0,pagination:!0,pageSize:10,pageList:[5,10,25,50,100,200],search:!0,showColumns:!0,showRefresh:!0,minimumCountColumns:2,clickToSelect:!1,maintainSelected:!0,uniqueId:"userName",columns:[{field:"userName",title:"用户名",align:"center",valign:"bottom"},{field:"email",title:"邮箱",align:"center",valign:"middle"},{field:"nickName",title:"昵称",align:"center",valign:"middle"},{field:"trueName",title:"真实姓名",align:"center",valign:"middle",sortable:!0},{field:"createdAt",title:"创建时间",align:"center",valign:"middle",formatter:n,sortable:!0},{field:"updatedAt",title:"更新时间",align:"left",valign:"top",formatter:n,sortable:!0},{field:"op",title:"操作",align:"center",valign:"middle",clickToSelect:!1,formatter:i}]}},e.addOrEdit="add",e.addOrEditBool=!1,$("#userTable").on("click",".opBtn",function(a){var t=$(a.target).parent().attr("data-op"),n=$("#userTable").bootstrapTable("getRowByUniqueId",$(a.currentTarget).attr("data-userName"));"edit"===t?e.$apply(function(){e.showEdit(n)}):"delete"===t?e.$apply(function(){e.showRemove(n)}):"editUserRole"===t&&r.go("userRoleManage",{userName:n.userName})}),e.showAdd=function(){e.addOrEdit="add",e.addOrEditBool=!1,e.userName=e.email=e.passWord=e.nickName=e.trueName="",$("#addAndEditModal").modal("show")},e.showEdit=function(a){e.userName=a.userName,e.addOrEdit="edit",e.addOrEditBool=!0,e.email=a.email,e.passWord="",e.nickName=a.nickName,e.trueName=a.trueName,$("#addAndEditModal").modal("show")},e.showRemove=function(a){e.userName=a.userName,$("#deleteModal").modal("show")},e.deleteNavBtn=function(){t({url:config.api+"/user/delete",method:"POST",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"*/*"},transformRequest:$.param,data:{userName:e.userName}}).then(function(t){"ok"===t.data.status&&(new a({type:"danger",text:"删除成功"}),e.userName=e.email=e.passWord=e.nickName=e.trueName="",$("#deleteModal").modal("hide"),$("#userTable").bootstrapTable("refresh"))})},e.addAndEditNavBtn=function(){"edit"==e.addOrEdit?t({url:config.api+"/user/edit",method:"POST",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"*/*"},transformRequest:$.param,data:{userName:e.userName,email:e.email,passWord:e.passWord,nickName:e.nickName,trueName:e.trueName}}).then(function(t){new a({type:"info",text:"修改成功"}),e.userName=e.email=e.passWord=e.nickName=e.trueName="",$("#addAndEditModal").modal("hide"),$("#userTable").bootstrapTable("refresh")},function(e){new a({type:"error",text:"修改失败"})}):"add"==e.addOrEdit&&t({url:config.api+"/user/add",method:"POST",withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"*/*"},transformRequest:$.param,data:{userName:e.userName,email:e.email,passWord:e.passWord,nickName:e.nickName,trueName:e.trueName}}).then(function(t){new a({type:"info",text:"添加成功"}),e.userName=e.email=e.passWord=e.nickName=e.trueName="",$("#addAndEditModal").modal("hide"),$("#userTable").bootstrapTable("refresh")},function(e){new a({type:"error",text:"添加失败"})})}}]}}});